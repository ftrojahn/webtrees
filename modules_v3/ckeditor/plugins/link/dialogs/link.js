CKEDITOR.dialog.add("link",function(P){function I(b){return b.replace(/'/g,"\\$&")}var h=CKEDITOR.plugins.link,o=function(){var k=this.getDialog(),j=k.getContentElement("target","popupFeatures"),k=k.getContentElement("target","linkTargetName"),l=this.getValue();if(j&&k){switch(j=j.getElement(),j.hide(),k.setValue(""),l){case"frame":k.setLabel(P.lang.link.targetFrameName);k.getElement().show();break;case"popup":j.show();k.setLabel(P.lang.link.targetPopupName);k.getElement().show();break;default:k.setValue(l),k.getElement().hide()}}},f=/^javascript:/,d=/^mailto:([^?]+)(?:\?(.+))?$/,c=/subject=([^;?:@&=$,\/]*)/,a=/body=([^;?:@&=$,\/]*)/,O=/^#(.*)$/,N=/^((?:http|https|ftp|news):\/\/)?(.*)$/,L=/^(_(?:self|top|parent|blank))$/,J=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,s=/^javascript:([^(]+)\(([^)]+)\)$/,i=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,g=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,e=function(k,j){var r=j&&(j.data("cke-saved-href")||j.getAttribute("href"))||"",p,q,n={};r.match(f)&&("encode"==M?r=r.replace(J,function(u,v,t){return"mailto:"+String.fromCharCode.apply(String,v.split(","))+(t&&t.replace(/\\'/g,"'"))}):M&&r.replace(s,function(u,z,t){if(z==K.name){n.type="email";u=n.email={};z=/(^')|('$)/g;t=t.match(/[^,\s]+/g);for(var y=t.length,x,w,v=0;v<y;v++){x=decodeURIComponent,w=t[v].replace(z,"").replace(/\\'/g,"'"),w=x(w),x=K.params[v].toLowerCase(),u[x]=w}u.address=[u.name,u.domain].join("@")}}));if(!n.type){if(p=r.match(O)){n.type="anchor",n.anchor={},n.anchor.name=n.anchor.id=p[1]}else{if(p=r.match(d)){q=r.match(c);r=r.match(a);n.type="email";var m=n.email={};m.address=p[1];q&&(m.subject=decodeURIComponent(q[1]));r&&(m.body=decodeURIComponent(r[1]))}else{r&&(q=r.match(N))?(n.type="url",n.url={},n.url.protocol=q[1],n.url.url=q[2]):n.type="url"}}}if(j){p=j.getAttribute("target");n.target={};n.adv={};if(p){p.match(L)?n.target.type=n.target.name=p:(n.target.type="frame",n.target.name=p)}else{if(p=(p=j.data("cke-pa-onclick")||j.getAttribute("onclick"))&&p.match(i)){n.target.type="popup";for(n.target.name=p[1];r=g.exec(p[2]);){("yes"==r[2]||"1"==r[2])&&!(r[1] in {height:1,width:1,top:1,left:1})?n.target[r[1]]=!0:isFinite(r[2])&&(n.target[r[1]]=r[2])}}}p=function(b,u){var t=j.getAttribute(u);null!==t&&(n.adv[b]=t||"")};p("advId","id");p("advLangDir","dir");p("advAccessKey","accessKey");n.adv.advName=j.data("cke-saved-name")||j.getAttribute("name")||"";p("advLangCode","lang");p("advTabIndex","tabindex");p("advTitle","title");p("advContentType","type");CKEDITOR.plugins.link.synAnchorSelector?(r=n.adv,q=(q=j.getAttribute("class"))?q.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):"",r.advCSSClasses=q):p("advCSSClasses","class");p("advCharset","charset");p("advStyles","style");p("advRel","rel")}p=n.anchors=[];var l;if(CKEDITOR.plugins.link.emptyAnchorFix){m=k.document.getElementsByTag("a");r=0;for(q=m.count();r<q;r++){if(l=m.getItem(r),l.data("cke-saved-name")||l.hasAttribute("name")){p.push({name:l.data("cke-saved-name")||l.getAttribute("name"),id:l.getAttribute("id")})}}}else{m=new CKEDITOR.dom.nodeList(k.document.$.anchors);r=0;for(q=m.count();r<q;r++){l=m.getItem(r),p[r]={name:l.getAttribute("name"),id:l.getAttribute("id")}}}if(CKEDITOR.plugins.link.fakeAnchor){m=k.document.getElementsByTag("img");r=0;for(q=m.count();r<q;r++){(l=CKEDITOR.plugins.link.tryRestoreFakeAnchor(k,m.getItem(r)))&&p.push({name:l.getAttribute("name"),id:l.getAttribute("id")})}}this._.selectedElement=j;return n},U=function(b){b.target&&this.setValue(b.target[this.id]||"")},T=function(b){b.adv&&this.setValue(b.adv[this.id]||"")},R=function(b){b.target||(b.target={});b.target[this.id]=this.getValue()||""},Q=function(b){b.adv||(b.adv={});b.adv[this.id]=this.getValue()||""},M=P.config.emailProtection||"";if(M&&"encode"!=M){var K={};M.replace(/^([^(]+)\(([^)]+)\)$/,function(k,j,l){K.name=j;K.params=[];l.replace(/[^,\s]+/g,function(b){K.params.push(b)})})}var S=P.lang.common,V=P.lang.link;return{title:V.title,minWidth:350,minHeight:230,contents:[{id:"info",label:V.info,title:V.info,elements:[{id:"linkType",type:"select",label:V.type,"default":"url",items:[[V.toUrl,"url"],[V.toAnchor,"anchor"],[V.toEmail,"email"]],onChange:function(){var k=this.getDialog(),j=["urlOptions","anchorOptions","emailOptions"],n=this.getValue(),l=k.definition.getContents("upload"),l=l&&l.hidden;"url"==n?(P.config.linkShowTargetTab&&k.showPage("target"),l||k.showPage("upload")):(k.hidePage("target"),l||k.hidePage("upload"));for(l=0;l<j.length;l++){var m=k.getContentElement("info",j[l]);m&&(m=m.getElement().getParent().getParent(),j[l]==n+"Options"?m.show():m.hide())}k.layout()},setup:function(b){b.type&&this.setValue(b.type)},commit:function(b){b.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:S.protocol,"default":"http://",items:[["http://\u200e","http://"],["https://\u200e","https://"],["ftp://\u200e","ftp://"],["news://\u200e","news://"],[V.other,""]],setup:function(b){b.url&&this.setValue(b.url.protocol||"")},commit:function(b){b.url||(b.url={});b.url.protocol=this.getValue()}},{type:"text",id:"url",label:S.url,required:!0,onLoad:function(){this.allowOnChange=!0},onKeyUp:function(){this.allowOnChange=!1;var k=this.getDialog().getContentElement("info","protocol"),j=this.getValue(),m=/^((javascript:)|[#\/\.\?])/i,l=/^(http|https|ftp|news):\/\/(?=.)/i.exec(j);l?(this.setValue(j.substr(l[0].length)),k.setValue(l[0].toLowerCase())):m.test(j)&&k.setValue("");this.allowOnChange=!0},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var b=this.getDialog();return b.getContentElement("info","linkType")&&"url"!=b.getValueOf("info","linkType")||this.getDialog().fakeObj?!0:CKEDITOR.dialog.validate.notEmpty(V.noUrl).apply(this)},setup:function(b){this.allowOnChange=!1;b.url&&this.setValue(b.url.url);this.allowOnChange=!0},commit:function(b){this.onChange();b.url||(b.url={});b.url.url=this.getValue();this.allowOnChange=!1}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().show()}},{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:S.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:V.selectAnchor,setup:function(b){0<b.anchors.length?this.getElement().show():this.getElement().hide()},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:V.anchorName,style:"width: 100%;",items:[[""]],setup:function(k){this.clear();this.add("");for(var j=0;j<k.anchors.length;j++){k.anchors[j].name&&this.add(k.anchors[j].name)}k.anchor&&this.setValue(k.anchor.name);(k=this.getDialog().getContentElement("info","linkType"))&&"email"==k.getValue()&&this.focus()},commit:function(b){b.anchor||(b.anchor={});b.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:V.anchorId,style:"width: 100%;",items:[[""]],setup:function(k){this.clear();this.add("");for(var j=0;j<k.anchors.length;j++){k.anchors[j].id&&this.add(k.anchors[j].id)}k.anchor&&this.setValue(k.anchor.id)},commit:function(b){b.anchor||(b.anchor={});b.anchor.id=this.getValue()}}],setup:function(b){0<b.anchors.length?this.getElement().show():this.getElement().hide()}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="note" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(V.noAnchors)+"</div>",focus:!0,setup:function(b){1>b.anchors.length?this.getElement().show():this.getElement().hide()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:V.emailAddress,required:!0,validate:function(){var b=this.getDialog();return !b.getContentElement("info","linkType")||"email"!=b.getValueOf("info","linkType")?!0:CKEDITOR.dialog.validate.notEmpty(V.noEmail).apply(this)},setup:function(b){b.email&&this.setValue(b.email.address);(b=this.getDialog().getContentElement("info","linkType"))&&"email"==b.getValue()&&this.select()},commit:function(b){b.email||(b.email={});b.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:V.emailSubject,setup:function(b){b.email&&this.setValue(b.email.subject)},commit:function(b){b.email||(b.email={});b.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:V.emailBody,rows:3,"default":"",setup:function(b){b.email&&this.setValue(b.email.body)},commit:function(b){b.email||(b.email={});b.email.body=this.getValue()}}],setup:function(){this.getDialog().getContentElement("info","linkType")||this.getElement().hide()}}]},{id:"target",label:V.target,title:V.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:S.target,"default":"notSet",style:"width : 100%;",items:[[S.notSet,"notSet"],[V.targetFrame,"frame"],[V.targetPopup,"popup"],[S.targetNew,"_blank"],[S.targetTop,"_top"],[S.targetSelf,"_self"],[S.targetParent,"_parent"]],onChange:o,setup:function(b){b.target&&this.setValue(b.target.type||"notSet");o.call(this)},commit:function(b){b.target||(b.target={});b.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:V.targetFrameName,"default":"",setup:function(b){b.target&&this.setValue(b.target.name)},commit:function(b){b.target||(b.target={});b.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:"100%",align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:V.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:V.popupResizable,setup:U,commit:R},{type:"checkbox",id:"status",label:V.popupStatusBar,setup:U,commit:R}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:V.popupLocationBar,setup:U,commit:R},{type:"checkbox",id:"toolbar",label:V.popupToolbar,setup:U,commit:R}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:V.popupMenuBar,setup:U,commit:R},{type:"checkbox",id:"fullscreen",label:V.popupFullScreen,setup:U,commit:R}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:V.popupScrollBars,setup:U,commit:R},{type:"checkbox",id:"dependent",label:V.popupDependent,setup:U,commit:R}]},{type:"hbox",children:[{type:"text",widths:["50%","50%"],labelLayout:"horizontal",label:S.width,id:"width",setup:U,commit:R},{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:V.popupLeft,id:"left",setup:U,commit:R}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:S.height,id:"height",setup:U,commit:R},{type:"text",labelLayout:"horizontal",label:V.popupTop,widths:["50%","50%"],id:"top",setup:U,commit:R}]}]}]}]},{id:"upload",label:V.upload,title:V.upload,hidden:!0,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:S.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:S.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:V.advanced,title:V.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",label:V.id,setup:T,commit:Q},{type:"select",id:"advLangDir",label:V.langDir,"default":"",style:"width:110px",items:[[S.notSet,""],[V.langDirLTR,"ltr"],[V.langDirRTL,"rtl"]],setup:T,commit:Q},{type:"text",id:"advAccessKey",width:"80px",label:V.acccessKey,maxLength:1,setup:T,commit:Q}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:V.name,id:"advName",setup:T,commit:Q},{type:"text",label:V.langCode,id:"advLangCode",width:"110px","default":"",setup:T,commit:Q},{type:"text",label:V.tabIndex,id:"advTabIndex",width:"80px",maxLength:5,setup:T,commit:Q}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:V.advisoryTitle,"default":"",id:"advTitle",setup:T,commit:Q},{type:"text",label:V.advisoryContentType,"default":"",id:"advContentType",setup:T,commit:Q}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:V.cssClasses,"default":"",id:"advCSSClasses",setup:T,commit:Q},{type:"text",label:V.charset,"default":"",id:"advCharset",setup:T,commit:Q}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:V.rel,"default":"",id:"advRel",setup:T,commit:Q},{type:"text",label:V.styles,"default":"",id:"advStyles",validate:CKEDITOR.dialog.validate.inlineStyle(P.lang.common.invalidInlineStyle),setup:T,commit:Q}]}]}]}],onShow:function(){var k=this.getParentEditor(),j=k.getSelection(),l=null;(l=h.getSelectedLink(k))&&l.hasAttribute("href")?j.selectElement(l):l=null;this.setupContent(e.apply(this,[k,l]))},onOk:function(){var y={},x=[],w={},u=this.getParentEditor();this.commitContent(w);switch(w.type||"url"){case"url":var v=w.url&&void 0!=w.url.protocol?w.url.protocol:"http://",t=w.url&&CKEDITOR.tools.trim(w.url.url)||"";y["data-cke-saved-href"]=0===t.indexOf("/")?t:v+t;break;case"anchor":v=w.anchor&&w.anchor.id;y["data-cke-saved-href"]="#"+(w.anchor&&w.anchor.name||v||"");break;case"email":v=w.email;t=v.address;switch(M){case"":case"encode":var r=encodeURIComponent(v.subject||""),q=encodeURIComponent(v.body||""),v=[];r&&v.push("subject="+r);q&&v.push("body="+q);v=v.length?"?"+v.join("&"):"";if("encode"==M){for(var q=t.length,m=[],p=0;p<q;p++){r=t.charCodeAt(p),m.push(r)}t=["javascript:void(location.href='mailto:'+","String.fromCharCode("+m.join(",")+")"];v&&t.push("+'",I(v),"'");t.push(")")}else{t=["mailto:",t,v]}break;default:t=t.split("@",2);v.name=t[0];v.domain=t[1];r=K.params;t=[K.name,"("];for(p=0;p<r.length;p++){q=r[p].toLowerCase(),m=v[q],0<p&&t.push(","),t.push("'",m?I(encodeURIComponent(v[q])):"","'")}t.push(")");t=["javascript:",t.join("")]}y["data-cke-saved-href"]=t.join("")}if(w.target){if("popup"==w.target.type){for(var v=["window.open(this.href, '",w.target.name||"","', '"],n="resizable status location toolbar menubar fullscreen scrollbars dependent".split(" "),t=n.length,r=function(b){w.target[b]&&n.push(b+"="+w.target[b])},q=0;q<t;q++){n[q]+=w.target[n[q]]?"=yes":"=no"}r("width");r("left");r("height");r("top");v.push(n.join(","),"'); return false;");y["data-cke-pa-onclick"]=v.join("");x.push("target")}else{"notSet"!=w.target.type&&w.target.name?y.target=w.target.name:x.push("target"),x.push("data-cke-pa-onclick","onclick")}}w.adv&&(v=function(k,j){var b=w.adv[k];b?y[j]=b:x.push(j)},v("advId","id"),v("advLangDir","dir"),v("advAccessKey","accessKey"),w.adv.advName?y.name=y["data-cke-saved-name"]=w.adv.advName:x=x.concat(["data-cke-saved-name","name"]),v("advLangCode","lang"),v("advTabIndex","tabindex"),v("advTitle","title"),v("advContentType","type"),v("advCSSClasses","class"),v("advCharset","charset"),v("advStyles","style"),v("advRel","rel"));v=u.getSelection();y.href=y["data-cke-saved-href"];if(this._.selectedElement){u=this._.selectedElement;t=u.data("cke-saved-href");r=u.getHtml();u.setAttributes(y);u.removeAttributes(x);w.adv&&(w.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector)&&u.addClass(u.getChildCount()?"cke_anchor":"cke_anchor_empty");if(t==r||"email"==w.type&&-1!=r.indexOf("@")){u.setHtml("email"==w.type?w.email.address:y["data-cke-saved-href"])}v.selectElement(u);delete this._.selectedElement}else{t=v.getRanges(!0),1==t.length&&t[0].collapsed&&(r=new CKEDITOR.dom.text("email"==w.type?w.email.address:y["data-cke-saved-href"],u.document),t[0].insertNode(r),t[0].selectNodeContents(r),v.selectRanges(t)),v=new CKEDITOR.style({element:"a",attributes:y}),v.type=CKEDITOR.STYLE_INLINE,v.apply(u.document)}},onLoad:function(){P.config.linkShowAdvancedTab||this.hidePage("advanced");P.config.linkShowTargetTab||this.hidePage("target")},onFocus:function(){var b=this.getContentElement("info","linkType");b&&"url"==b.getValue()&&(b=this.getContentElement("info","url"),b.select())}}});